#!/bin/sh

help() {
	echo Documentation
}

arch="$(uname -m)"
CC=
CROSS_COMPILE=
THREADS="$(cat /proc/cpuinfo|grep '^model name'|wc -l)"

[ -z "$CFLAGS" ] && CFLAGS='-Os -s'

while [ -n "$1" ]; do
	val="$(printf "%s\n" "$1"|cut '-d=' -f2)"
	case "$1" in
	        '--arch='*)
	                arch="$val"
	                shift 1
	                ;;
		'--cflags='*)
			CFLAGS="$val"
			shift 1
			;;
		'--ldflags='*)
			LDFLAGS="$val"
			shift 1
			;;
		*)
			echo "Unknown option: $1" >&2
			help >&2
			exit 1
			;;
	esac
done

echo "Looking for suitable installs of GCC"
for _cc in `ls $(echo $PATH|tr ':' ' ')|grep 'gcc$'|sort -u`; do
	echo "Trying $_cc..."
	touple=$($_cc -dumpmachine|grep "$arch"|grep "musl")
	[ -n "$touple" ] && CC="$_cc" && break
done

[ -z "$CC" ] && echo "No $arch musl compiler found" && exit 1
echo "Using $CC"

if [ "$CC" = "${touple}-gcc" ]; then
	CROSS_COMPILE="${touple}-"
fi

(
	echo "CC=$CC"
	echo "CROSS_COMPILE=$CROSS_COMPILE"
	echo "CFLAGS=$CFLAGS"
	echo "LDFLAGS=$LDFLAGS"
	echo "THREADS=$THREADS"
) > config.mk
